<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Оценка викторины</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .star-rating-interactive {
            direction: rtl;
            display: inline-block;
            font-size: 2.5rem;
            unicode-bidi: bidi-override;
            text-align: center;
        }

        .star-rating-interactive input[type="radio"] {
            display: none;
        }

        .star-rating-interactive label {
            color: #ddd;
            cursor: pointer;
            display: inline-block;
            margin: 0 5px;
            position: relative;
            transition: transform 0.2s, color 0.2s;
        }

        .star-rating-interactive label:hover,
        .star-rating-interactive label:hover ~ label,
        .star-rating-interactive input[type="radio"]:checked ~ label {
            color: #ffc107;
            transform: scale(1.1);
        }

        .star-tooltip {
            position: relative;
        }

        .tooltip-text {
            visibility: hidden;
            width: 80px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -40px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
        }

        .star-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .rating-selected {
            min-height: 30px;
            text-align: center;
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .modal-rating-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            margin: -1rem -1rem 1rem -1rem;
            border-radius: 0.3rem 0.3rem 0 0;
        }

        .modal-rating-header h5 {
            color: white;
            margin: 0;
        }

        .modal-rating-body {
            padding: 1.5rem 0;
        }

        #submitRating:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .form-text {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .modal-content {
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<!-- Модальное окно для оценки -->
<div th:fragment="ratingModal">
    <div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true"
         data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-rating-header">
                    <div class="modal-header border-0">
                        <h5 class="modal-title" id="ratingModalLabel">
                            <i class="bi bi-star-fill me-2"></i>Оцените викторину
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="text-center">
                        <p>Поделитесь своим мнением о пройденной викторине</p>
                    </div>
                </div>

                <div class="modal-body">
                    <!-- Интерактивный рейтинг -->
                    <div class="text-center mb-4">
                        <div class="star-rating-interactive" id="interactiveRating">
                            <input type="radio" id="modal-star5" name="modal-rating" value="5">
                            <label for="modal-star5" title="Отлично" class="star-tooltip">
                                ★
                                <span class="tooltip-text">Отлично</span>
                            </label>

                            <input type="radio" id="modal-star4" name="modal-rating" value="4">
                            <label for="modal-star4" title="Хорошо" class="star-tooltip">
                                ★
                                <span class="tooltip-text">Хорошо</span>
                            </label>

                            <input type="radio" id="modal-star3" name="modal-rating" value="3">
                            <label for="modal-star3" title="Нормально" class="star-tooltip">
                                ★
                                <span class="tooltip-text">Нормально</span>
                            </label>

                            <input type="radio" id="modal-star2" name="modal-rating" value="2">
                            <label for="modal-star2" title="Плохо" class="star-tooltip">
                                ★
                                <span class="tooltip-text">Плохо</span>
                            </label>

                            <input type="radio" id="modal-star1" name="modal-rating" value="1">
                            <label for="modal-star1" title="Ужасно" class="star-tooltip">
                                ★
                                <span class="tooltip-text">Ужасно</span>
                            </label>
                        </div>

                        <div class="rating-selected mt-3" id="ratingSelectedText">
                            <span class="text-muted">Выберите оценку от 1 до 5 звёзд</span>
                        </div>
                    </div>

                    <!-- Комментарий -->
                    <div class="modal-rating-comment mb-3">
                        <label for="modalComment" class="form-label fw-bold">
                            <i class="bi bi-chat-left-text me-2"></i>Комментарий (необязательно):
                        </label>
                        <textarea class="form-control" id="modalComment"
                                  rows="3" placeholder="Напишите ваш комментарий здесь..."
                                  maxlength="500"
                                  style="border: 1px solid #dee2e6; border-radius: 8px;"></textarea>
                        <div class="form-text text-end mt-1">
                            <span id="charCount">0</span>/500 символов
                        </div>
                    </div>

                    <!-- Скрытые поля -->
                    <input type="hidden" id="modalQuizId" value="">
                    <input type="hidden" id="modalSessionId" value="">
                </div>

                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-outline-secondary me-2" id="skipRating" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Пропустить оценку
                    </button>
                    <button type="button" class="btn btn-primary" id="submitRating" disabled>
                        <i class="bi bi-check-circle me-2"></i>Отправить оценку
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Инициализация обработчиков при загрузке документа
    document.addEventListener('DOMContentLoaded', function() {
        initRatingModalHandlers();
    });

    function initRatingModalHandlers() {
        const modalElement = document.getElementById('ratingModal');
        if (!modalElement) {
            console.log('Модальное окно не найдено в DOM');
            return;
        }

        console.log('Инициализация обработчиков модального окна');

        // Обработчик для звезд
        const stars = modalElement.querySelectorAll('#interactiveRating input[type="radio"]');
        console.log('Найдено звезд:', stars.length);

        stars.forEach((star, index) => {
            star.addEventListener('change', function() {
                console.log('Выбрана звезда:', this.value);
                updateSelectedRating(this.value);
            });

            // событие клика на лейбл
            const label = modalElement.querySelector(`label[for="modal-star${index + 1}"]`);
            if (label) {
                label.addEventListener('click', function(e) {
                    console.log('Клик по лейблу звезды:', index + 1);
                    e.preventDefault();
                });
            }
        });

        // Обработчик для текстового поля
        const commentTextarea = modalElement.querySelector('#modalComment');
        const charCount = modalElement.querySelector('#charCount');

        if (commentTextarea && charCount) {
            commentTextarea.addEventListener('input', function() {
                const length = this.value.length;
                charCount.textContent = length;
                if (length > 500) {
                    this.value = this.value.substring(0, 500);
                    charCount.textContent = 500;
                }
            });
        }

        // Обработчик для кнопки отправки
        const submitBtn = modalElement.querySelector('#submitRating');
        if (submitBtn) {
            submitBtn.addEventListener('click', function() {
                console.log('Нажата кнопка отправки');
                const ratingInput = modalElement.querySelector('#interactiveRating input[type="radio"]:checked');
                const commentTextarea = modalElement.querySelector('#modalComment');
                const quizIdInput = modalElement.querySelector('#modalQuizId');
                const sessionIdInput = modalElement.querySelector('#modalSessionId');

                if (!ratingInput) {
                    alert('Пожалуйста, выберите оценку');
                    return;
                }

                const rating = ratingInput.value;
                const comment = commentTextarea ? commentTextarea.value : '';
                const quizId = quizIdInput ? quizIdInput.value : '';
                const sessionId = sessionIdInput ? sessionIdInput.value : '';

                console.log('Отправка оценки:', { rating, comment, quizId, sessionId });
                submitRatingToServer(rating, comment, quizId, sessionId);
            });
        }

        // Обработчик для кнопки пропуска
        const skipBtn = modalElement.querySelector('#skipRating');
        if (skipBtn) {
            skipBtn.addEventListener('click', function() {
                const quizIdInput = modalElement.querySelector('#modalQuizId');
                if (quizIdInput && quizIdInput.value) {
                    localStorage.setItem(`ratingSkipped_${quizIdInput.value}`, 'true');
                }
            });
        }
    }

    function updateSelectedRating(rating) {
        const ratingText = document.querySelector('#ratingSelectedText');
        const submitBtn = document.querySelector('#submitRating');

        console.log('Обновление выбранной оценки:', rating);

        if (submitBtn) {
            submitBtn.disabled = false;
            console.log('Кнопка отправки активирована');
        }

        const ratingTexts = {
            '1': 'Ужасно',
            '2': 'Плохо',
            '3': 'Нормально',
            '4': 'Хорошо',
            '5': 'Отлично'
        };

        if (ratingText) {
            ratingText.innerHTML = `
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    Вы выбрали: <strong>${rating} звезд${rating > 1 ? 'ы' : (rating == 1 ? 'у' : '')}</strong>
                    (${ratingTexts[rating]})
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
        }
    }

    function submitRatingToServer(rating, comment, quizId, sessionId) {
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        const headers = {
            'Content-Type': 'application/json'
        };

        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }

        console.log('Отправка запроса на сервер...');

        fetch('/ratings/rate-after-play', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                rating: parseFloat(rating),
                comment: comment,
                quizId: parseInt(quizId),
                sessionId: sessionId
            })
        })
            .then(response => {
                console.log('Ответ сервера получен:', response.status);
                if (!response.ok) {
                    throw new Error('Ошибка сети: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Данные ответа:', data);
                if (data.success) {
                    // Закрываем модальное окно
                    const modal = bootstrap.Modal.getInstance(document.getElementById('ratingModal'));
                    if (modal) {
                        modal.hide();
                    }

                    // сообщение об успехе
                    alert('Спасибо за вашу оценку!');

                    // Перенаправляем на страницу деталей
                    setTimeout(() => {
                        window.location.href = `/quizzes/details/${quizId}`;
                    }, 500);
                } else {
                    alert(data.message || 'Ошибка при сохранении оценки');
                }
            })
            .catch(error => {
                console.error('Ошибка при отправке оценки:', error);
                alert('Произошла ошибка при отправке оценки. Пожалуйста, попробуйте еще раз.');
            });
    }
</script>

</body>
</html>